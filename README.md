#### ziying - API开放平台

##### Projects
背景：xxx项目团队，它运营着一个广受学生青睐的在线coding平台，为学生提供了一个可自由部署项目代码环境。随着业务的扩展，xxx团队希望与知名大学、各大厂训练营和其他友商合作伙伴平台进行集成。此外，为了满足学生多样化的学习需求，xxx团队希望开放平台API，允许第三方开发者基于平台API开发在IDE产品上开发项目。

##### Product requirements
提供 API 接口供开发者调用的平台
- 管理员可以接入并发布接口
- 统计分析各接口调用情况
- xxx团队用户可以注册登录并开通接口调用权限
- 在线浏览接口、在线调试
- 可以使用客户端SDK在代码中调用接口

##### requests
1. 保证安全性，防止攻击
2. 不能随便被调用 （权限设置：限制 非社区用户无法使用 ）
3. 统计接口的调用次数
4. 计费
5. 流量保护
6. API接入 
7. ==

##### realization
- go version go1.22.1 linux/amd64
- github.com/gin-gonic/gin v1.9.1
- Redis
- MySQL
- ...


##### design
**API 签名认证**
详细说明：
由于我们为开发者提供了调用接口，但我们对调用者一无所知。服务器的资源却是有限的，我们需要对接口设置保护措施，防止恶意调用、影响用户的正常使用。
使用API签名认证，我会给用户提供一个凭证，作为授权或者许可证。用户要有这个许可证才可以使用我们的接口。

认证流程：
1. 签发签名
2. 校验签名 （类似短信接口的key）

具体思路：
我们需要使用 accessKey（访问密钥） 和 secretKey（密钥）。用户每次调用接口的时候都要带上 accessKey 和 secretKey，以此实现无状态的请求。
注意：一般来说 accessKey 和 secretKey 需要尽可能复杂，以防止他人破解。

为什么需要两个 key ？
如果一个key就可以调用接口，那么任何人拿到这个key就可以无限制地调用这个接口，就好比登录网站既需要用户名，又需要密码。（token 就只有一个key，本质上它是不安全的，有可能通过重放等方式破解）


思路实现：
我们可以通过 http request header 头传递参数
- 参数1: accessKey 调用的标识 用户1、用户2 (复杂、无序、无规律)
- 参数2: secretKey 密钥 (复杂、无序、无规律) 注意：该参数不可以放在请求头中
- 参数3: 用户请求参数
- 参数4: sign 生成的签名

加密方式：
对称加密、非对称加密、md5签名（不可破解）
用户参数 + 密钥 =》签名生成算法（ MD5、HMac、Sha1 ）=》 不可解密的值

如何判断签名是否正确：
服务端使用一模一样的参数和加密算法去生成签名，只要和用户传入的签名一致，就说明请求是合法的。

如何防重放：
- 参数5: 加随机数，只能用一次 （服务端要保存用过的随机数）
- 参数6: 加时间戳，校验时间戳
  API签名认证是一个很灵活的设计，具体需要哪些参数可以根据对应场景去进行构思。

**解析**
通过加入随机数实现防重放：
每次发送请求时，会发送一个随机数给后端。后端接受并认可该随机数一次，一旦随机数被使用过，后端将不再接受相同的随机数。
注意，由于该方法需要后端额外去处理保存的（已使用的）随机数。若出现接口的并发量很大的情况（面临处理百万以上的请求），我们需要新增其他机制，去定期清理已经使用的随机数。

通过加入一个时间戳实现防重放：
每个请求在发送时会携带一个时间戳，并且后端会验证该时间戳时否在指定的时间范围内，例：不超过10分钟或5分钟。防止他人使用之前的请求进行重放。通过该方式，我们可以在一定程度上控制随机数的过期时间。只要时间戳过期或随机数被使用过，后端都会拒绝该请求。因此，使用时间戳可以在一定程度上减轻后端保存随机数的负担。






